DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `batchUpdateBillTotal`$$

CREATE DEFINER=`root`@`%` PROCEDURE `batchUpdateBillTotal`()
BEGIN
       
    DECLARE V_BILL_NO INT DEFAULT 0;
    DECLARE done BOOLEAN DEFAULT FALSE;     
    DECLARE cur CURSOR FOR 
    SELECT b.BILL_NO
    FROM  xly_bill b;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  
  OPEN cur;
    SET @a=0;
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH cur INTO V_BILL_NO;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;  
      UPDATE xly_bill SET TOTAL_AMOUNT=countTotalAmount(V_BILL_NO) WHERE BILL_NO=V_BILL_NO;
	
   
  END LOOP;
  CLOSE cur;  
    END$$

DELIMITER ;