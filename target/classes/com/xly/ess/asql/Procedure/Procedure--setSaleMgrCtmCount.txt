DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `setSaleMgrCtmCount`$$

CREATE DEFINER=`root`@`%` PROCEDURE `setSaleMgrCtmCount`(IN V_MONTH VARCHAR(7))
BEGIN
    
    DECLARE V_SALE_MGR_ID INT DEFAULT 0;
	
    DECLARE V_COUNT INT DEFAULT 0;
    DECLARE done BOOLEAN DEFAULT FALSE;     
    DECLARE cur CURSOR FOR 
    SELECT  vm.salesMgrId FROM v_mgr vm;
    OPEN cur;
    SET @a=0;
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH cur INTO V_SALE_MGR_ID;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    SET @a=@a+1;
    SELECT COUNT(1) INTO V_COUNT FROM (SELECT DISTINCT b.ctmId FROM v_simple_bill  b WHERE LEFT(b.`billTime`,7)=V_MONTH AND b.salesMgrId=V_SALE_MGR_ID) a;
    -- 销售经理Id和月份确定唯一行
    IF V_COUNT > 0 THEN
    UPDATE xly_mgr_sale SET CTM_COUNT=V_COUNT WHERE SALE_MGR_ID=V_SALE_MGR_ID AND END_MONTH=V_MONTH;
    END IF;
	
  END LOOP;
  CLOSE cur;  
	SELECT @a;
    END$$

DELIMITER ;