DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `addBatchBillRecord`$$

CREATE DEFINER=`root`@`%` PROCEDURE `addBatchBillRecord`(
    V_CTMID INT ,
    S_ID1 INT ,
    v_count INT ,
    PRICE DOUBLE 
    )
BEGIN
     
    DECLARE V_SALE_MGR_ID INT DEFAULT 0;
    DECLARE i INT DEFAULT 1;
	
    DECLARE LAST_ID INT DEFAULT 0;
    DECLARE pId INT DEFAULT 0;
    INSERT INTO xly_bill (BILL_TIME,CTM_ID,FREIGHT,DRIVER_PHONE,CAR_NO,CREATER,REMARK,BILL_TYPE)
    VALUES(NOW(),V_CTMID,200,'15019861460','JMMM23','System','ÅúÁ¿','ÆÕÍ¨');
    SELECT LAST_INSERT_ID() INTO LAST_ID;
    
    REPEAT 
    SELECT getPIdByStockId(S_ID1) INTO pId;
    INSERT INTO xly_bill_record (BILL_NO,STOCK_ID,COUNT,PRICE,BENCHMARK)
    VALUES(LAST_ID,S_ID1,v_count*i,30,getBenchmarkByPId(pId));
    SET i = i + 1;  
    UNTIL i >= 5 
    END REPEAT;  
    UPDATE xly_bill SET TOTAL_AMOUNT=countTotalAmount(LAST_ID) WHERE BILL_NO=LAST_ID;
    END$$

DELIMITER ;