DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `unFreezeStock`$$

CREATE DEFINER=`root`@`%` PROCEDURE `unFreezeStock`(OUT p_out VARCHAR (100))
BEGIN
DECLARE F_ID INT (11) ;
DECLARE STOCK_ID INT (11) ;
DECLARE STOCK_COUNT INT (11) ;
DECLARE CUR_RECORD CURSOR FOR 
SELECT whf.FREEZE_ID,whf.STOCK_ID ,whf.COUNT FROM  xly_wh_freeze whf 
  WHERE STR_TO_DATE(whf.END_DATE,'%Y-%m-%d')<NOW() ;
  DECLARE EXIT HANDLER FOR NOT FOUND CLOSE CUR_RECORD;  
  SET p_out="";
  OPEN CUR_RECORD;
  REPEAT  
  FETCH CUR_RECORD INTO F_ID,STOCK_ID,STOCK_COUNT;  
/**	
 select F_ID,STOCK_ID,STOCK_COUNT;
 **/
	UPDATE `xly_wh_freeze` SET STATE = 0 WHERE FREEZE_ID=F_ID;
    UPDATE xly_pdt_stock SET STOCK = STOCK+STOCK_COUNT WHERE ID=STOCK_ID;
    
  SET p_out=p_out+":"+F_ID;    
  UNTIL 0 END REPEAT;
  CLOSE CUR_RECORD;  
  END$$

DELIMITER ;