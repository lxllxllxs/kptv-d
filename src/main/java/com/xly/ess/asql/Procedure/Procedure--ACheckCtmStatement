DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `ACheckCtmStatement`$$

CREATE DEFINER=`root`@`%` PROCEDURE `ACheckCtmStatement`()
BEGIN
  DECLARE V_CTM_ID INT DEFAULT 0;
    DECLARE V_CTM_NAME VARCHAR(20);
    DECLARE LAST_BAL DOUBLE DEFAULT 0;
    DECLARE CURR_BAL DOUBLE DEFAULT 0;
    DECLARE THIS_MONTH_CUP DOUBLE DEFAULT 0;
    DECLARE THIS_MONTH_BAL DOUBLE DEFAULT 0;
    
    DECLARE done BOOLEAN DEFAULT FALSE;  
    DECLARE cur CURSOR FOR 
    SELECT 
	vc.`ctmName`,
	cb.`BALANCE`,
	vc.`money` ,
	(SELECT getNowCtmConsumption(cb.`CTM_ID`)),
	(SELECT getNowCtmBal(cb.`CTM_ID`))
	 FROM xly_ctm_bal cb,v_customer vc
	WHERE cb.`CTM_ID`=vc.`ctmId` AND cb.`END_MONTH`=LEFT(DATE_SUB(NOW(),INTERVAL 1 MONTH),7);
	 CREATE TEMPORARY TABLE IF NOT EXISTS temp_incorrect_ctm_bal
(ctmName VARCHAR(20),lastMonthCtmBal DOUBLE NOT NULL,currBal DOUBLE NOT NULL,thisMonCup DOUBLE NOT NULL,thisMonBal DOUBLE NOT NULL) ENGINE = MYISAM DEFAULT CHARSET = utf8;
TRUNCATE TABLE temp_incorrect_ctm_bal; -- 使用前先清空临时表。	
    OPEN cur;
    SET @a=0;
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH cur INTO V_CTM_NAME,LAST_BAL,CURR_BAL,THIS_MONTH_CUP,THIS_MONTH_BAL;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    IF LAST_BAL=CURR_BAL+THIS_MONTH_BAL-THIS_MONTH_CUP THEN
    INSERT INTO temp_incorrect_ctm_bal(ctmName,lastMonthCtmBal,currBal,thisMonCup,thisMonBal)
    VALUES(V_CTM_NAME,LAST_BAL,CURR_BAL,THIS_MONTH_CUP,THIS_MONTH_BAL);
    SET @a=@a+1;
    END IF;
  END LOOP;
  CLOSE cur;
  SELECT @a;
    END$$

DELIMITER ;