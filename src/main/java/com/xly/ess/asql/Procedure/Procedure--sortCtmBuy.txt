DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `sortCtmBuy`$$

CREATE DEFINER=`root`@`%` PROCEDURE `sortCtmBuy`(IN V_MONTH VARCHAR(7))
BEGIN
    DECLARE V_SALE_MGR_ID INT DEFAULT 0;
    DECLARE V_CTM_ID INT DEFAULT 0;
    DECLARE V_CTM_NAME VARCHAR(10);
    DECLARE V_SALE_MGR_NAME VARCHAR(10);
	
    DECLARE V_BRAND_ID INT DEFAULT 0;
    DECLARE V_TYPE_ID INT DEFAULT 0;
    DECLARE V_AMOUNT DOUBLE DEFAULT 0;
     
    DECLARE V_RECORD_COUNT INT DEFAULT 0;
    DECLARE done BOOLEAN DEFAULT FALSE;     
    -- 已对数据有效性进行筛选
    DECLARE cur CURSOR FOR 
    SELECT vbr.ctmId,vbr.ctmName,vbr.`brandId`,vbr.`typeId`,vbr.`salesMgrId`,salesMgrName,vbr.`subTotal`
    FROM  v_buy_record vbr 
    WHERE LEFT(vbr.`billTime`,7)=V_MONTH;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  
  OPEN cur;
    SET @a=0;
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH cur INTO V_CTM_ID,V_CTM_NAME,V_BRAND_ID,V_TYPE_ID,V_SALE_MGR_ID,V_SALE_MGR_NAME,V_AMOUNT;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    -- Id和月份确定唯一行
	SELECT COUNT(*) INTO V_RECORD_COUNT FROM xly_ctm_buy cb WHERE  cb.`CTM_ID`=V_CTM_ID AND END_MONTH=V_MONTH;
    -- 这里做你想做的循环的事件
	IF V_RECORD_COUNT = 0 THEN
	INSERT INTO xly_ctm_buy(SALE_MGR_ID,SALE_MGR_NAME,CTM_ID,CTM_NAME,CREATE_DATE,END_MONTH) 
	VALUES(V_SALE_MGR_ID,V_SALE_MGR_NAME,V_CTM_ID,V_CTM_NAME,NOW(),V_MONTH);
	END IF;
	-- 11是曼宜森--全抛釉
	IF V_BRAND_ID=1 AND V_TYPE_ID=1 THEN
	UPDATE xly_ctm_buy SET MYS_Q=MYS_Q+V_AMOUNT WHERE  CTM_ID=V_CTM_ID AND END_MONTH=V_MONTH;
	-- 12是曼宜森--金刚石
	ELSEIF V_BRAND_ID=1 AND V_TYPE_ID=2 THEN
	UPDATE xly_ctm_buy SET MYS_J=MYS_J+V_AMOUNT WHERE  CTM_ID=V_CTM_ID  AND END_MONTH=V_MONTH;
	-- 21是布达米亚--全抛釉
	ELSEIF V_BRAND_ID=2 AND V_TYPE_ID=1 THEN
	UPDATE xly_ctm_buy SET BDMY_Q=BDMY_Q+V_AMOUNT WHERE  CTM_ID=V_CTM_ID  AND END_MONTH=V_MONTH;
	-- 22是布达米亚--金刚石
	ELSEIF V_BRAND_ID=2 AND V_TYPE_ID=2 THEN
	UPDATE xly_ctm_buy SET BDMY_J=BDMY_J+V_AMOUNT WHERE  CTM_ID=V_CTM_ID AND END_MONTH=V_MONTH;
	-- 31是新圣悦--全抛釉
	ELSEIF V_BRAND_ID=3 AND V_TYPE_ID=1 THEN
	UPDATE xly_ctm_buy SET XSY_Q=XSY_Q+V_AMOUNT WHERE  CTM_ID=V_CTM_ID AND END_MONTH=V_MONTH;
	-- 32是新圣悦--金刚石
	ELSEIF V_BRAND_ID=3 AND V_TYPE_ID=2 THEN
	UPDATE xly_ctm_buy SET XSY_J=XSY_J+V_AMOUNT WHERE  CTM_ID=V_CTM_ID AND END_MONTH=V_MONTH;
	-- 43是牧梵--超白坯
	ELSE 
	UPDATE xly_ctm_buy SET MF_C=MF_C+V_AMOUNT WHERE  CTM_ID=V_CTM_ID AND END_MONTH=V_MONTH;
	SET @a=@a+1;
    END IF;
  END LOOP;
  CLOSE cur;  
    END$$

DELIMITER ;