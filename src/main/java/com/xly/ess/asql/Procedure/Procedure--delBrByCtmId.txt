DELIMITER $$

USE `xly`$$

DROP PROCEDURE IF EXISTS `delBrByCtmId`$$
-- 根据客户Id 删除其开票记录
CREATE DEFINER=`root`@`%` PROCEDURE `delBrByCtmId`(ctmId INT)
BEGIN

    DECLARE done BOOLEAN DEFAULT FALSE;   
    DECLARE V_BILL_NO INT;  
    -- 已对数据有效性进行筛选
    DECLARE cur CURSOR FOR 
    SELECT b.BILL_NO
    FROM  xly_bill b
    WHERE b.CTM_ID=ctmId;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  
  OPEN cur;
    SET @a=0;
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH cur INTO V_BILL_NO;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    CALL delBrByBillNo(V_BILL_NO);
    
  END LOOP;
  CLOSE cur;  
    END$$

DELIMITER ;